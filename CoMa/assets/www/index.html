<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport"
	content="width=device-width, minimum-scale=1, maximum-scale=1">
<title>CoMa</title>

<link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.1/jquery.mobile-1.4.1.min.css" />
<script type="text/javascript" src="js/libs/jquery-1.7.1/jquery.min.js"></script>
<script type="text/javascript" src="js/libs/jquery-mobile-1.0.1/jquery.mobile-1.4.2.min.js"></script>
<script type="text/javascript" src="js/cordova.js"></script>

<script type="text/javascript">
	//add listener when device ready
	document.addEventListener("deviceready", onDeviceReady, false);
	var db = window.openDatabase("Congress", "1.0", "congress", 0);
	var resultado;
	//function will be called when device ready
	function onDeviceReady() {
		//Creamos las tablas Congresos y Actividades y metemos datos de prueba
		db.transaction(populateCon, errorCB, successCB);
		
		//Query de la inicializacion de datos en la app
		db.transaction(populate2, errorCB, success2);
	}
	
	function p (callback){
		  db.transaction(function coletandovisitas(tx){
			  tx.executeSql('SELECT Nombre FROM Congresos', [], function x(tx, results){
			    var array_retorno = new Array();
			    $.each(results.rows, function(index) {
			    	var row = results.rows.item(index);
			    	array_retorno[index] = row['Nombre'];
			    });
			    callback(array_retorno);
			  }, function err(){} );            
			  },function erro(){}, function acerto(){} );
	}
	
	//create table and insert some record
	function populateCon(tx) {
		tx.executeSql('CREATE TABLE IF NOT EXISTS Congresos (Nombre VARCHAR(20) PRIMARY KEY NOT NULL, Fecha_ini DATE, Fecha_ fin DATE, Informacion VARCHAR(40), Ciudad VARCHAR(20))');
		//tx.executeSql('INSERT INTO Congresos VALUES ("Congreso1", "2015-08-13", "2015-08-17", "Se trata de un congreso de prueba 1", "Granada")');
		//tx.executeSql('INSERT INTO Congresos VALUES ("Congreso2", "2015-08-13", "2015-08-17", "Se trata de un congreso de prueba 2", "Sevilla")');
		//tx.executeSql('INSERT INTO Congresos VALUES ("Congreso3", "2015-08-13", "2015-08-17", "Se trata de un congreso de prueba 3", "Cadiz")');
		
		tx.executeSql('CREATE TABLE IF NOT EXISTS Actividades (NombreAct VARCHAR(20) PRIMARY KEY NOT NULL, NombreCon VARCHAR(20) NOT NULL, Hora_ini DATETIME, Hora_fin DATETIME, Informacion VARCHAR(40))');
		//tx.executeSql('INSERT INTO Actividades VALUES ("Meeting Patata","Congreso1","2015-08-13T17:30:00","2015-08-13T20:30:00", "Meeting sobre Patatas, una fuente de alimentacion")');

	}
	
	//create table and insert some record
	function populate2(t2) {
		
	}
	//function will be called when an error occurred
	function errorCB(err) {
		alert("Error processing SQL: " + err.code);
	}
	//function will be called when process succeed
	function successCB() {
		db.transaction(queryDB, errorCB);
	}
	
	function success2() {
		db.transaction(query2, errorCB);
	}
	
	var chcon = "Congreso1";
	
	function query2(t2) {
		q = "SELECT Informacion, Ciudad FROM Congresos WHERE Nombre = \'" + chcon + "\';";
		t2.executeSql(q, [], querySuccess2, errorCB);
	}
	
	function queryDB(tx) {
		tx.executeSql('SELECT Nombre, Fecha_ini FROM Congresos', [], querySuccess, errorCB);
	}
	
	
	// Rellena el congreso que esta picado.
	function querySuccess2(t2, result2) {
		$('#info').empty();
		$.each(result2.rows, function(index) {
			var row = result2.rows.item(index);
			$('#info').append(
					'<h1>' + row['Informacion'] + '</h1>');
		});
		$('#info').listview();
		
		$('#city').empty();
		$.each(result2.rows, function(index) {
			var row = result2.rows.item(index);
			$('#city').append(
					'<h1>' + row['Ciudad'] + '</h1>');
		});
		$('#city').listview();
	}
	
	
	//Query de los congresos en la base de datos, para my congress
	function querySuccess(tx, result) {
		$('#CongressList').empty();
		$.each(result.rows, function(index) {
			var row = result.rows.item(index);
			$('#CongressList').append(
					'<li id = "'+row['Nombre']+'"><a href="#"><h3 class="ui-li-heading">'
							+ row['Nombre']
							+ '</h3><p class="ui-li-desc">Fecha '
							+ row['Fecha_ini'] + '</p></a></li>');
		});
		
		$('#CongressList').listview();
	}
	
    $(document).ready(function(){
		p(function (array_retorno) {
    		$.each(array_retorno, function(index, value) {
    			var n  = "\"#" + array_retorno[index] + "\"";
    			$(n).live('click',function () {
            		chcon = array_retorno[index];
            		db.transaction(populate2, errorCB, success2);
            	});
    		});
		});          
            
    });
</script>

</head>
<body>

	<!--HEADER!-->

	<div data-role="header" data-theme="b">
		<h1>CoMa!!</h1>
	</div>

	<!--NAVBAR!!-->
	<div data-role="content">
		<div data-role="tabs" id="tabs">
			<div data-role="navbar">
				<ul>
					<li><a href="#info" data-ajax="false">Info</a></li>
					<li><a href="#city" data-ajax="false">City</a></li>
					<li><a href="#news" data-ajax="false">News</a></li>
				</ul>
			</div>
			
			<!-- DENTRO DE INFO -->
			<div id="info" class="ui-body-d ui-content">
			</div>
			
			<!-- DENTRO DE CITY -->
			<div id="city">
			</div>
			
			<!-- DENTRO DE NEWS -->
			<div id="news">
			
				<a class="twitter-timeline" href="https://twitter.com/tichatuch" data-widget-id="482081557960617985">Tweets por @tichatuch</a>

				<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id))
				{js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}
				(document,"script","twitter-wjs");</script>

			</div>
		</div>
	</div>
	
	<!-- PANEL OPTIONS -->
	<div data-role="panel" id="panel1" data-display="push"
		data-position-fixed="true" data-theme="b">
		<div data-role="content">
			<ul data-role="listview">
				<li><a href="#">Language</a></li>
				<li><a href="#">Download</a></li>
				<li><a href="#">About</a></li>

			</ul>
		</div>
	</div>

	<!--FOOTER-->
	<div data-role="footer" data-theme="b" data-position="fixed">
		<!-- BOTÃ“N MY CONGRESS -->
		<a href="#popupMenu" data-rel="popup"
			class="ui-btn ui-shadow ui-btn-inline ui-icon-grid 
               ui-btn-icon-left ui-btn-a"
			style="float: right">My Congress </a>

		<div data-role="popup" id="popupMenu" data-theme="b">
			<div data-role="content">
				<ul id="CongressList">
				</ul>
			</div>
		</div>

		<!-- BOTON OPTIONS -->
		<a href="#panel1" data-rel="popup"
			class="ui-btn ui-shadow ui-btn-inline ui-icon-gear 
               ui-btn-icon-left ui-btn-a"
			style="float: left">Options</a>

	</div>


</body>
</html>